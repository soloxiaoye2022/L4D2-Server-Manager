# 重构 L4D2 服务器管理器 (TUI版)

## 1. 核心架构设计
*   **多实例管理**: 使用 `config.ini` 或 `servers.dat` 记录已部署的服务器列表 (格式: `服务器名|安装路径|端口|状态`).
*   **交互界面**: 封装一套统一的 Bash TUI 库 (基于 `read` 和 ANSI 转义码), 实现菜单选择、输入框、确认框.
*   **进程管理**: 废弃 `screen`, 采用 **`tmux`** (功能更强, 支持分屏/滚动/会话保持).
*   **守护进程**: 为每个服务器生成独立的 `start.sh` 脚本, 内部包含 `while true` 循环实现崩溃自动重启, 并在 `tmux` 会话中运行.

## 2. 功能模块划分

### A. 初始化与依赖 (Silent Mode)
*   **检测**: 启动时静默检测 `tmux`, `curl`, `wget`, `tar`, `lib32gcc` 等.
*   **安装**: 根据 OS (Debian/Ubuntu/CentOS) 自动调用 `apt` 或 `yum` 安装缺失组件, 不弹窗干扰.
*   **菜单**: 提供“依赖管理”入口, 可查看状态及强制重装.

### B. 部署向导 (Deploy Wizard)
1.  **信息录入**: TUI 输入框获取 "服务器名称" (唯一性检查) 和 "安装目录".
2.  **SteamCMD 登录**:
    *   提供 "匿名登录" 和 "账号登录" 选项.
    *   账号登录时, 检测 SteamCMD 的交互输出, 提示用户输入令牌 (Steam Guard).
3.  **下载/更新**: 调用 SteamCMD 下载 AppID 222860.
4.  **初始化配置**: 生成默认 `server.cfg` 和启动脚本.

### C. 服务器管理 (Server Manager)
*   **列表页**: 显示所有服务器及其状态 (运行中/已停止).
*   **控制台 (Dashboard)**:
    *   **基本操作**: 启动, 停止, 重启.
    *   **控制台交互**: 使用 `tmux attach -t session_name` 进入交互模式 (提示用户按 `Ctrl+B, D` 退出).
    *   **插件管理**: 复用并升级现有的 TUI 插件安装/卸载逻辑, 适配多目录.
    *   **启动项管理**: TUI 编辑器修改启动参数 (地图, 人数, 端口等).
    *   **日志查看**: `tail -f` 实时读取日志文件.

### D. 插件与资源
*   复用现有 `JS-MODS` 逻辑, 但需传入目标服务器路径参数, 实现针对特定实例的插件安装.

## 3. 实现步骤
1.  **基础库封装**: 编写 `tui_lib.sh` (绘制方框, 菜单, 输入).
2.  **重写主逻辑**: 创建新版 `manager.sh`, 替换原有的 case 结构.
3.  **进程守护实现**: 编写通用的 `run_guard.sh` 模板.
4.  **迁移旧功能**: 将原来的插件安装/平台安装逻辑移植为模块函数.
5.  **测试验证**: 验证多实例隔离性及 tmux 交互.

此计划将彻底重写脚本结构, 确保满足所有需求.
